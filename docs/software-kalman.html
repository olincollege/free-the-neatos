<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="author" content="Stephan Risi" />
    <meta charset="utf-8" />

    <!-- Favicon -->
    <link rel="icon" type="image/jpeg" href="images/home.jpg" />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>
    <title>Kalman Filter - Free the Neatos</title>
    <script>
      $(function () {
        $("#header").load("header.html");
      });
    </script>
    <link href="css/main.css" rel="stylesheet" />
    <script>
      // Mobile menu toggle functionality - use event delegation since header loads asynchronously
      $(document).ready(function () {
        function setupMobileMenu() {
          // Toggle mobile menu - use event delegation
          $(document).off("click", ".mobile-menu-toggle").on("click", ".mobile-menu-toggle", function (e) {
            e.preventDefault();
            e.stopPropagation();
            var isActive = $(this).hasClass("active");
            $(this).toggleClass("active");
            $(".sidebar").toggleClass("active");
            $(".mobile-overlay").toggleClass("active");
            // Prevent body scroll when menu is open
            if (!isActive) {
              $("body").addClass("menu-open");
            } else {
              $("body").removeClass("menu-open");
            }
          });

          // Close menu when overlay is clicked
          $(document).off("click", ".mobile-overlay").on("click", ".mobile-overlay", function (e) {
            e.preventDefault();
            e.stopPropagation();
            $(".mobile-menu-toggle").removeClass("active");
            $(".sidebar").removeClass("active");
            $(this).removeClass("active");
            $("body").removeClass("menu-open");
          });
        }

        // Set up mobile menu immediately and after delays to ensure header is loaded
        setupMobileMenu();
        setTimeout(setupMobileMenu, 100);
        setTimeout(setupMobileMenu, 500);
        setTimeout(setupMobileMenu, 1000);
      });

      // Close menu when a nav link is clicked (on mobile) - use event delegation
      $(document).on("click", ".nav-link", function () {
        if ($(window).width() <= 767) {
          $(".mobile-menu-toggle").removeClass("active");
          $(".sidebar").removeClass("active");
          $(".mobile-overlay").removeClass("active");
          $("body").removeClass("menu-open");
        }
      });

      // Set up active links and add decorative image after header loads
      $(document).ready(function () {
        function setupNavigation() {
          var currentPage =
            window.location.pathname.split("/").pop() || "index.html";
          var isMilestonePage = currentPage.includes("milestone");
          var isSoftwarePage = currentPage.includes("software");

          $(".nav-link").each(function () {
            var linkHref = $(this).attr("href");
            if (!linkHref) return;

            var linkPage = linkHref.split("#")[0].split("/").pop();

            // Check if this link matches current page
            if (
              linkPage === currentPage ||
              (currentPage === "" && linkPage === "index.html") ||
              (isMilestonePage &&
                linkHref.includes("milestone") &&
                currentPage === linkPage) ||
              (isSoftwarePage &&
                linkHref.includes("software") &&
                currentPage === linkPage)
            ) {
              $(this).addClass("active");
            }
          });

          // Add decorative robot image to sidebar
          if ($(".sidebar-decorative-image").length === 0) {
            $(".sidebar-nav").after(
              '<div class="sidebar-decorative-image"><img src="images/both.png" alt="Robot doodle" /></div>'
            );
          }
        }

        // Try to set up navigation immediately, and also after a short delay to ensure header is loaded
        setTimeout(setupNavigation, 100);
        setTimeout(setupNavigation, 500);
      });
    </script>
  </head>

  <body>
    <div id="header"></div>
    <main class="main-content">
      <div class="content-wrapper">
        <h1>Extended Kalman Filter</h1>
        <p>
          Our localization system is built around an Extended Kalman Filter
          (EKF) that fuses wheel odometry and 2D LiDAR data to estimate the
          robot's pose in a known map. The EKF provides a probabilistic
          framework that accounts for sensor noise and model uncertainty (though
          no noise ended up being modeled in simulation due to time constraint)
          while continuously refining the robot's position and orientation in
          the global map frame.
        </p>

        <h2>State Representation</h2>
        <p>The EKF state vector is defined as:</p>
        <p>
          <img src="images/image5.png" alt="EKF State" class="content-img" />
        </p>
        <p>
          where x and y represent the robot's position in the map frame, and
          theta is the orientation. The associated covariance matrix represents
          the uncertainty in each state.
        </p>

        <h2>Prediction Step</h2>
        <p>
          The prediction step uses incremental odometry measurements derived
          from wheel encoder data, where the incremental linear and orientation
          displacements are computed and used as the control input:
        </p>
        <p>
          <img
            src="images/image11.png"
            alt="EKF Prediction"
            class="content-img"
          />
        </p>
        <p>
          A nonlinear motion model propagates the state forward assuming planar
          motion with small rotational increments, defined below:
        </p>
        <p>
          <img
            src="images/image9.png"
            alt="EKF Motion Model"
            class="content-img"
          />
        </p>
        <p>
          The EKF linearizes this model about the current estimate using
          Jacobians with respect to both the state and control input.
          Velocity-dependent process noise is incorporated to reflect increased
          uncertainty during motion.
        </p>
        <p>
          This step produces a predicted state and covariance before measurement
          is taken into account.
        </p>

        <h2>Measurement Step</h2>
        <p>
          To obtain an absolute pose measurement, the system performs
          scan-to-map alignment using Iterative Closest Point (ICP). Each
          incoming LiDAR scan is converted into a 2D point cloud in the robot's
          base frame and aligned against another point cloud which represents
          occupied grids from the occupancy field / map. The predicted pose from
          the EKF is used as the initial guess for ICP, and the resulting
          rigid-body transformation that results in alignment between the two
          point clouds provides a measured, absolute pose estimate. Below is a
          set of plots showing how ICP can correct for an inaccurate pose
          prediction resulting from the motion model:
        </p>
        <p>
          <img
            src="images/image1.png"
            alt="ICP Correction"
            class="content-img"
          />
        </p>

        <h2>Correction Step</h2>
        <p>
          The EKF correction step fuses the ICP-based pose measurement with the
          predicted state. The measurement model directly observes position and
          orientation, allowing the use of an identity measurement matrix.
          Measurement noise is tuned to reflect ICP uncertainty, with larger
          variance assigned to orientation to account for scan ambiguity and
          environmental symmetry. The Kalman gain balances trust between
          odometry prediction and LiDAR-based correction, yielding a refined
          pose estimate and reduced uncertainty.
        </p>
        <p>
          Once the refined pose estimate is computed, it is then published to
          its own topic "ekf_pose", where other algorithms, such as the one
          calculating waypoint drive commands, have easy access to.
        </p>

        <h2>EKF Demo</h2>
        <p>
          <img
            src="images/kalman_filter.gif"
            alt="Mapping Algorithm"
            class="content-img"
          />
        </p>
      </div>
    </main>
  </body>
</html>
